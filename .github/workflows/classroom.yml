name: E2E (docker-compose)

on:
  - push
  - pull_request
  - workflow_dispatch

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    if: github.actor != 'github-classroom[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show docker versions
        run: |
          docker --version
          docker compose version || docker-compose --version

      - name: Start services
        run: |
          # Поддержим оба варианта команды: docker compose (v2) и docker-compose (v1)
          if docker compose version; then
            docker compose up -d --build
          else
            docker-compose up -d --build
          fi

      - name: Wait for service on :8080
        shell: bash
        run: |
          set -euo pipefail

          URL="http://localhost:8080/"
          echo "Waiting for ${URL} ..."

          # Ждём до 120 секунд
          for i in {1..120}; do
            if curl -fsS "$URL" >/dev/null 2>&1; then
              echo "Service is up!"
              exit 0
            fi
            sleep 1
          done

          echo "Service did not become ready in time"
          echo "---- docker compose logs ----"
          if docker compose version; then
            docker compose ps
            docker compose logs --no-color --tail=200
          else
            docker-compose ps
            docker-compose logs --no-color --tail=200
          fi
          exit 1

      - name: Run e2e tests
        env: 
          BASE_URL: "http://localhost:8080"
        run: |
          ./tests/agoge-cli e2e-tests --task=agoge-e2e-shop --base-url=${BASE_URL}

      - name: Stop services (always)
        if: always()
        run: |
          if docker compose version; then
            docker compose down -v
          else
            docker-compose down -v
          fi
